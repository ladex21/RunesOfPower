<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runes of Power</title>
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a2e;
            color: #e6e6ff;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            width: 800px;
            max-width: 100%;
            background-color: #16213e;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        /* Game screens */
        .screen {
            display: none;
            flex-direction: column;
            padding: 20px;
            transition: opacity 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        
        .screen.active {
            display: flex;
            opacity: 1;
            visibility: visible;
        }
        
        /* Rune selection screen */
        #rune-selection-screen {
            align-items: center;
            text-align: center;
        }
        
        .rune-selection-title {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .rune-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .rune-button {
            width: 100px;
            height: 100px;
            border: 2px solid #ccc;
            border-radius: 5px;
            background: none;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .rune-button:hover {
            transform: scale(1.05);
            border-color: white;
        }
        
        /* Game screen */
        #game-screen {
            position: relative;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .player-info {
            display: flex;
            flex-direction: column;
            width: 48%;
        }
        
        .monster-info {
            display: flex;
            flex-direction: column;
            width: 48%;
            text-align: right;
        }
        
        .stat-display {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 5px;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .hp-fill {
            background-color: #4caf50;
        }
        
        .mana-fill {
            background-color: #2196F3;
        }
        
        .exp-fill {
            background-color: #9c27b0;
        }
        
        .monster-hp-fill {
            background-color: #f44336;
        }
        
        .combat-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        
        .entity {
            width: 100px;
            height: 100px;
            position: relative;
        }
        
        .entity img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .damaged {
            animation: damaged 0.3s;
        }
        
        @keyframes damaged {
            0%, 100% { transform: translate(0, 0); opacity: 1; }
            25% { transform: translate(-5px, 0); opacity: 0.8; }
            50% { transform: translate(5px, 0); opacity: 0.9; }
            75% { transform: translate(-5px, 0); opacity: 0.8; }
        }
        
        .game-log {
            height: 150px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .log-message {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .info {
            color: #e6e6ff;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .warning {
            color: #FFC107;
        }
        
        .error {
            color: #F44336;
        }
        
        .damage {
            color: #FF9800;
        }
        
        .damage-taken {
            color: #F44336;
        }
        
        .heal {
            color: #4CAF50;
        }
        
        .event {
            color: #2196F3;
        }
        
        .event-critical {
            color: #E91E63;
            font-weight: bold;
        }
        
        .exp-gain {
            color: #9C27B0;
        }
        
        .gold-gain {
            color: #FFD700;
        }
        
        .effectiveness {
            color: #00BCD4;
        }
        
        .skill-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .skill-button {
            padding: 8px 12px;
            background-color: #0d47a1;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .skill-button:hover:not(:disabled) {
            background-color: #1565c0;
        }
        
        .skill-button:disabled {
            background-color: #455a64;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .skill-button.available {
            border: 1px solid #4CAF50;
        }
        
        .skill-button.insufficient-mana {
            border: 1px solid #F44336;
        }
        
        .skill-button.waiting {
            background-color: #607d8b;
        }
        
        .game-actions {
            display: flex;
            gap: 10px;
        }
        
        .game-button {
            padding: 8px 12px;
            background-color: #0d47a1;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .game-button:hover {
            background-color: #1565c0;
        }
        
        /* Status effects */
        .status-effects-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .status-effect {
            font-size: 12px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .buff {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }
        
        .debuff {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid #F44336;
        }
        
        .neutral {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
        }
        
        /* Area selection screen */
        #area-selection-screen {
            padding: 20px;
        }
        
        .area-selection-title {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .area-selection-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .area-option {
            background-color: #263859;
            border-radius: 5px;
            padding: 15px;
            transition: transform 0.2s;
        }
        
        .area-option:hover {
            transform: translateY(-5px);
        }
        
        .area-name {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .area-description {
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .area-recommendation {
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .area-recommendation.danger {
            color: #F44336;
        }
        
        .area-recommendation.easy {
            color: #4CAF50;
        }
        
        .area-element {
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .element-advantage {
            color: #4CAF50;
        }
        
        .element-disadvantage {
            color: #F44336;
        }
        
        .enter-area-button {
            width: 100%;
            padding: 8px 12px;
            background-color: #0d47a1;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .enter-area-button:hover {
            background-color: #1565c0;
        }
        
        .back-button {
            padding: 8px 12px;
            background-color: #455a64;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 0 auto;
            display: block;
        }
        
        .back-button:hover {
            background-color: #546e7a;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }
        
        .modal-content {
            background-color: #263859;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-header {
            border-bottom: 1px solid #0d47a1;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .modal-header h2 {
            margin-top: 0;
        }
        
        .modal-footer {
            border-top: 1px solid #0d47a1;
            padding-top: 15px;
            margin-top: 15px;
            text-align: right;
        }
        
        .modal-close-button {
            padding: 8px 16px;
            background-color: #455a64;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        
        .modal-close-button:hover {
            background-color: #546e7a;
        }
        
        /* Shop modal */
        .shop-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #0d47a1;
        }
        
        .shop-tab {
            padding: 8px 15px;
            cursor: pointer;
            background: none;
            border: none;
            color: #e6e6ff;
            opacity: 0.7;
        }
        
        .shop-tab:hover {
            opacity: 0.9;
        }
        
        .shop-tab.active {
            opacity: 1;
            border-bottom: 2px solid #2196F3;
        }
        
        .shop-gold-display {
            margin-bottom: 15px;
            font-size: 16px;
            color: #FFD700;
        }
        
        .shop-items-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .shop-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 10px;
        }
        
        .shop-item:last-child {
            border-bottom: none;
        }
        
        .shop-item-icon {
            font-size: 24px;
            min-width: 30px;
            text-align: center;
        }
        
        .shop-item-details {
            flex-grow: 1;
        }
        
        .shop-item-name {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .shop-item-description {
            display: block;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .shop-item-price {
            color: #FFD700;
            margin-right: 10px;
        }
        
        .shop-buy-button {
            padding: 5px 10px;
            background-color: #0d47a1;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
        
        .shop-buy-button:hover:not(:disabled) {
            background-color: #1565c0;
        }
        
        .shop-buy-button:disabled {
            background-color: #455a64;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Inventory modal */
        .inventory-container {
            display: flex;
            gap: 20px;
        }
        
        .equipment-slots {
            width: 40%;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding-right: 15px;
        }
        
        .inventory-items {
            width: 60%;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .equipment-slot {
            margin-bottom: 15px;
        }
        
        .slot-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .slot-content {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 5px;
        }
        
        .unequip-button {
            padding: 3px 8px;
            background-color: #455a64;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            margin-left: auto;
        }
        
        .unequip-button:hover {
            background-color: #546e7a;
        }
        
        .inventory-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 10px;
        }
        
        .inventory-item:last-child {
            border-bottom: none;
        }
        
        .item-icon {
            font-size: 24px;
            min-width: 30px;
            text-align: center;
        }
        
        .item-details {
            flex-grow: 1;
        }
        
        .item-name {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .item-description {
            display: block;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .item-actions {
            display: flex;
            gap: 5px;
        }
        
        .use-item-button, .equip-item-button {
            padding: 3px 8px;
            background-color: #0d47a1;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
        
        .use-item-button:hover, .equip-item-button:hover {
            background-color: #1565c0;
        }
        
        .empty-inventory {
            padding: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Rune swap modal */
        .current-active-rune {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .current-rune-icon {
            width: 80px;
            height: 80px;
        }
        
        .current-rune-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .unlocked-runes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .unlocked-rune {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .rune-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
        }
        
        .rune-name {
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .switch-rune-button {
            width: 100%;
            padding: 5px 10px;
            background-color: #0d47a1;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
        
        .switch-rune-button:hover {
            background-color: #1565c0;
        }
        
        /* Level up modal */
        .level-up-message {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .new-level {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }
        
        .stats-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .stat-label {
            text-align: right;
            font-weight: bold;
        }
        
        .stat-arrow {
            text-align: center;
            color: #2196F3;
        }
        
        .stat-value {
            text-align: left;
        }
        
        .old-stat {
            opacity: 0.7;
            text-decoration: line-through;
        }
        
        .new-stat {
            color: #4CAF50;
            font-weight: bold;
        }
        
        /* Error display */
        #error-log-display {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 15px;
            border-radius: 5px;
            max-width: 400px;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .error-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .error-message {
            margin-bottom: 10px;
        }
        
        .error-details {
            display: none;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        
        .error-actions {
            display: flex;
            justify-content: space-between;
        }
        
        .error-button {
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
        
        .error-button:hover {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Error history */
        .error-history-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .error-history-entry {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .error-entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .error-timestamp {
            opacity: 0.7;
            font-size: 12px;
        }
        
        .error-details-toggle {
            padding: 3px 8px;
            background-color: #455a64;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        
        .error-details-toggle:hover {
            background-color: #546e7a;
        }
        
        .error-stack {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        
        .empty-error-history {
            padding: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- Early Error Display -->
    <div id="error-log-display">
        <div class="error-title">Error</div>
        <div id="error-message-span" class="error-message"></div>
        <div id="error-details" class="error-details">
            <pre id="error-stack"></pre>
        </div>
        <div class="error-actions">
            <button id="error-expand-button" class="error-button">Details</button>
            <button id="error-history-button" class="error-button">Show History</button>
        </div>
    </div>

    <div class="container">
        <!-- Rune Selection Screen -->
        <div id="rune-selection-screen" class="screen">
            <h2 class="rune-selection-title">Choose Your Elemental Rune</h2>
            <div class="rune-options">
                <button id="fire-rune-btn" class="rune-button" data-rune="Fire">
                    <span class="rune-icon">🔥</span>
                    <span class="rune-name">Fire</span>
                </button>
                <button id="water-rune-btn" class="rune-button" data-rune="Water">
                    <span class="rune-icon">💧</span>
                    <span class="rune-name">Water</span>
                </button>
                <button id="nature-rune-btn" class="rune-button" data-rune="Nature">
                    <span class="rune-icon">🌿</span>
                    <span class="rune-name">Nature</span>
                </button>
                <button id="light-rune-btn" class="rune-button" data-rune="Light">
                    <span class="rune-icon">✨</span>
                    <span class="rune-name">Light</span>
                </button>
                <button id="dark-rune-btn" class="rune-button" data-rune="Dark">
                    <span class="rune-icon">🌑</span>
                    <span class="rune-name">Dark</span>
                </button>
            </div>
            <p>Choose wisely! Each rune grants different elemental powers.</p>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="player-info">
                    <div class="stat-display">Rune: <span id="player-rune-display">None</span> | Level: <span id="player-level">1</span> | Gold: <span id="player-gold">0</span></div>
                    <div class="stat-display">ATK: <span id="player-attack">7</span> | DEF: <span id="player-defense">3</span></div>
                    <div id="player-status-effects-area" class="status-effects-area"></div>
                    <div class="stat-display">HP: <span id="player-hp-text">100/100</span></div>
                    <div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemax="100">
                        <div id="player-hp-fill" class="progress-fill hp-fill" style="width:100%"></div>
                    </div>
                    <div class="stat-display">MP: <span id="player-mana-text">50/50</span></div>
                    <div class="progress-bar" role="progressbar" aria-valuenow="50" aria-valuemax="50">
                        <div id="player-mana-fill" class="progress-fill mana-fill" style="width:100%"></div>
                    </div>
                    <div class="stat-display">EXP: <span id="player-exp-text">0/100</span></div>
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemax="100">
                        <div id="player-exp-fill" class="progress-fill exp-fill" style="width:0%"></div>
                    </div>
                </div>
                <div class="monster-info">
                    <div class="stat-display"><span id="monster-name">No Monster</span></div>
                    <div class="stat-display">Type: <span id="monster-type">---</span> | Level: <span id="monster-level">--</span></div>
                    <div id="monster-status-effects-area" class="status-effects-area"></div>
                    <div class="stat-display">HP: <span id="monster-hp-text">--/--</span></div>
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemax="100">
                        <div id="monster-hp-fill" class="progress-fill monster-hp-fill" style="width:0%"></div>
                    </div>
                    <div class="stat-display">Monsters Defeated: <span id="monsters-defeated">0</span> | Next Boss: <span id="next-boss-counter">10</span></div>
                </div>
            </div>

            <div class="combat-area">
                <div class="entity player-entity">
                    <img id="player-avatar" src="" alt="Player">
                </div>
                <div id="mastery-progress-display"></div>
                <div class="entity monster-entity">
                    <img id="monster-sprite" src="" alt="Monster">
                </div>
            </div>

            <div id="game-log" class="game-log"></div>

            <div id="skill-buttons-area" class="skill-buttons"></div>

            <div class="game-actions">
                <button id="shop-button" class="game-button">Shop</button>
                <button id="inventory-button" class="game-button">Inventory</button>
                <button id="rune-swap-btn" class="game-button">Swap Rune</button>
                <button id="leave-town-button" class="game-button">Leave Town / Battle</button>
            </div>
        </div>

        <!-- Area Selection Screen -->
        <div id="area-selection-screen" class="screen">
            <h2 class="area-selection-title">Choose Your Destination</h2>
            <div id="area-selection-container" class="area-selection-container"></div>
            <button id="area-selection-back-btn" class="back-button">Return to Town</button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal" class="modal">
        <div class="modal-content">
            <span id="modal-close-button" class="close">&times;</span>
            <div class="modal-header">
                <h2>Shop</h2>
            </div>
            <div class="shop-gold-display">Your Gold: <span id="shop-current-gold">0</span></div>
            <div class="shop-tabs">
                <button class="shop-tab active" data-category="all">All</button>
                <button class="shop-tab" data-category="consumable">Consumables</button>
                <button class="shop-tab" data-category="weapon">Weapons</button>
                <button class="shop-tab" data-category="armor">Armor</button>
                <button class="shop-tab" data-category="accessory">Accessories</button>
            </div>
            <div id="shop-items-container" class="shop-items-container"></div>
            <div class="modal-footer">
                <button id="close-shop-button" class="modal-close-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventory-modal" class="modal">
        <div class="modal-content">
            <span id="inventory-modal-close-button" class="close">&times;</span>
            <div class="modal-header">
                <h2>Inventory</h2>
            </div>
            <div class="inventory-container">
                <div id="equipment-slots-container" class="equipment-slots"></div>
                <div id="inventory-items-container" class="inventory-items"></div>
            </div>
            <div class="modal-footer">
                <button id="close-inventory-button" class="modal-close-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Rune Swap Modal -->
    <div id="rune-swap-modal" class="modal">
        <div class="modal-content">
            <span id="rune-swap-modal-close-button" class="close">&times;</span>
            <div class="modal-header">
                <h2>Swap Rune</h2>
            </div>
            <div id="current-active-rune-display" class="current-active-rune"></div>
            <div id="unlocked-runes-container" class="unlocked-runes"></div>
            <div class="modal-footer">
                <button id="close-rune-swap-modal-button" class="modal-close-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div id="level-up-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Level Up!</h2>
            </div>
            <div class="level-up-message">
                <p>You've advanced to level <span id="new-level-display" class="new-level">2</span>!</p>
            </div>
            <div class="stats-comparison">
                <div class="stat-label">HP:</div>
                <div class="stat-arrow">→</div>
                <div class="stat-value"><span id="old-hp" class="old-stat">100</span> → <span id="new-hp" class="new-stat">134</span></div>
            </div>
            <div class="stats-comparison">
                <div class="stat-label">MP:</div>
                <div class="stat-arrow">→</div>
                <div class="stat-value"><span id="old-mp" class="old-stat">50</span> → <span id="new-mp" class="new-stat">65</span></div>
            </div>
            <div class="stats-comparison">
                <div class="stat-label">Attack:</div>
                <div class="stat-arrow">→</div>
                <div class="stat-value"><span id="old-attack" class="old-stat">7</span> → <span id="new-attack" class="new-stat">11</span></div>
            </div>
            <div class="stats-comparison">
                <div class="stat-label">Defense:</div>
                <div class="stat-arrow">→</div>
                <div class="stat-value"><span id="old-defense" class="old-stat">3</span> → <span id="new-defense" class="new-stat">5</span></div>
            </div>
            <div class="modal-footer">
                <button id="close-level-up-modal-button" class="modal-close-button">Continue</button>
            </div>
        </div>
    </div>

    <!-- Scripts in the correct order -->
    <script>
    /**
     * Early Initialization Fix - Solves the remaining initialization issues
     * This must be loaded BEFORE your main script.js
     */
    
    // Immediately execute to define critical functions and objects
    (function() {
      console.log("Early Init Fix: Running pre-initialization setup");
      
      // 1. Define initializeErrorLogger if missing
      if (typeof window.initializeErrorLogger !== 'function') {
        window.initializeErrorLogger = function() {
          console.log("Early Init Fix: Using replacement error logger initialization");
          const errorLogDisplay = document.getElementById('error-log-display');
          const errorExpandButton = document.getElementById('error-expand-button');
          const errorDetails = document.getElementById('error-details');
          
          if (errorLogDisplay && errorExpandButton && errorDetails) {
            errorLogDisplay.style.display = 'none';
            errorExpandButton.onclick = () => {
              const isExpanded = errorDetails.style.display === 'block';
              errorDetails.style.display = isExpanded ? 'none' : 'block';
              errorExpandButton.textContent = isExpanded ? 'Details' : 'Hide';
            };
          }
        };
        console.log("Early Init Fix: Defined missing initializeErrorLogger");
      }
      
      // 2. Ensure core data structures exist early
      if (!window.playerData) {
        window.playerData = {
          rune: null,
          level: 1,
          hp: 100,
          maxHp: 100,
          mana: 50,
          maxMana: 50,
          exp: 0,
          nextLevelExp: 100,
          gold: 30,
          skills: [],
          avatar: "",
          attackPower: 7,
          defense: 3,
          statusEffects: [],
          inventory: [],
          unlockedRunes: [],
          equipment: { weapon: null, shield: null, armor: null, accessory: null },
          hasRevivalStone: false,
          elementalBoostPercent: 0,
          skillMastery: {},
          version: "1.0.1"
        };
        console.log("Early Init Fix: Created missing playerData");
      }
      
      // 3. Define heroAvatars if missing
      if (!window.heroAvatars) {
        window.heroAvatars = {
          Default: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%238A2BE2'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E✧%3C/text%3E%3Ctext x='50' y='75' font-family='Arial' font-size='15' fill='white' text-anchor='middle'%3EHERO%3C/text%3E%3C/svg%3E",
          Fire: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23FF6347'/%3E%3Ctext x='50' y='45' font-family='Arial' font-size='40' fill='black' text-anchor='middle' dominant-baseline='middle'%3E🔥%3C/text%3E%3Ctext x='50' y='75' font-family='Arial' font-size='15' fill='black' text-anchor='middle'%3EFIRE%3C/text%3E%3C/svg%3E",
          Water: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%234682B4'/%3E%3Ctext x='50' y='45' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E💧%3C/text%3E%3Ctext x='50' y='75' font-family='Arial' font-size='15' fill='white' text-anchor='middle'%3EWATER%3C/text%3E%3C/svg%3E",
          Nature: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%233CB371'/%3E%3Ctext x='50' y='45' font-family='Arial' font-size='40' fill='black' text-anchor='middle' dominant-baseline='middle'%3E🌿%3C/text%3E%3Ctext x='50' y='75' font-family='Arial' font-size='15' fill='black' text-anchor='middle'%3ENATURE%3C/text%3E%3C/svg%3E",
          Light: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23FFFACD'/%3E%3Ctext x='50' y='45' font-family='Arial' font-size='40' fill='black' text-anchor='middle' dominant-baseline='middle'%3E✨%3C/text%3E%3Ctext x='50' y='75' font-family='Arial' font-size='15' fill='black' text-anchor='middle'%3ELIGHT%3C/text%3E%3C/svg%3E",
          Dark: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%234B0082'/%3E%3Ctext x='50' y='45' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E🌑%3C/text%3E%3Ctext x='50' y='75' font-family='Arial' font-size='15' fill='white' text-anchor='middle'%3EDARK%3C/text%3E%3C/svg%3E"
        };
        console.log("Early Init Fix: Created missing heroAvatars");
      }
      
      // 4. Define ELEMENTAL_TYPES if missing
      if (!window.ELEMENTAL_TYPES) {
        window.ELEMENTAL_TYPES = {
          Fire: { color: '#FF6347', textColor: '#FFFFFF', icon: '🔥', strong: ['Nature', 'Ice', 'Metal'], weak: ['Water', 'Earth', 'Rock'], neutral: ['Fire', 'Light', 'Dark', 'Lightning', 'Karma'] },
          Water: { color: '#4682B4', textColor: '#FFFFFF', icon: '💧', strong: ['Fire', 'Earth', 'Rock'], weak: ['Nature', 'Ice', 'Lightning'], neutral: ['Water', 'Light', 'Dark', 'Poison', 'Karma'] },
          Nature: { color: '#3CB371', textColor: '#FFFFFF', icon: '🌿', strong: ['Water', 'Earth', 'Rock'], weak: ['Fire', 'Ice', 'Poison', 'Flying'], neutral: ['Nature', 'Light', 'Dark', 'Karma'] },
          Light: { color: '#FFFACD', textColor: '#000000', icon: '✨', strong: ['Dark', 'Chaos', 'Undead'], weak: ['Void', 'Metal'], neutral: ['Fire', 'Water', 'Nature', 'Earth', 'Ice', 'Lightning'] },
          Dark: { color: '#4B0082', textColor: '#FFFFFF', icon: '🌑', strong: ['Light', 'Psychic', 'Spirit'], weak: ['Light', 'Holy', 'Pure'], neutral: ['Fire', 'Water', 'Nature', 'Earth', 'Ice', 'Lightning'] },
          Earth: { color: '#8B4513', textColor: '#FFFFFF', icon: '⛰️', strong: ['Lightning', 'Poison', 'Metal', 'Fire'], weak: ['Nature', 'Water', 'Ice'], neutral: ['Earth', 'Light', 'Dark'] },
          Ice: { color: '#E0FFFF', textColor: '#000000', icon: '❄️', strong: ['Nature', 'Flying', 'Dragon', 'Water'], weak: ['Fire', 'Metal', 'Fighting'], neutral: ['Ice', 'Light', 'Dark'] },
          Lightning: { color: '#FFD700', textColor: '#000000', icon: '⚡', strong: ['Water', 'Metal', 'Flying'], weak: ['Earth', 'Rock', 'Nature'], neutral: ['Lightning', 'Fire', 'Ice', 'Light', 'Dark'] },
          Normal: { color: '#A9A9A9', textColor: '#FFFFFF', icon: '⚪', strong: [], weak: ['Rock', 'Metal'], neutral: ['Normal', 'Fire', 'Water', 'Nature', 'Light', 'Dark', 'Earth', 'Ice', 'Lightning'] }
        };
        console.log("Early Init Fix: Created missing ELEMENTAL_TYPES");
      }
      
      // 5. Define GAME_AREAS if missing
      if (!window.GAME_AREAS) {
        window.GAME_AREAS = {
          town: { name: "Runehaven", description: "A small town where adventurers gather.", backgroundImage: "https://placehold.co/800x200/7B9E89/FFFFFF?text=Runehaven&font=pressstart2p", shops: ["generalStore", "magicEmporium", "blacksmith"], monsters: [], isSafe: true },
          forest: { name: "Whispering Woods", description: "An ancient forest.", backgroundImage: "https://placehold.co/800x200/2E8B57/FFFFFF?text=Whispering+Woods&font=pressstart2p", shops: [], monsters: ["Forest Wisp", "Vine Crawler"], isSafe: false, recommendedLevel: 1, dominantElement: "Nature" },
          volcano: { name: "Ember Peaks", description: "An active volcano.", backgroundImage: "https://placehold.co/800x200/B22222/FFFFFF?text=Ember+Peaks&font=pressstart2p", shops: [], monsters: ["Tiny Flame Imp", "Blaze Hound"], isSafe: false, recommendedLevel: 3, dominantElement: "Fire" },
          lake: { name: "Crystal Lake", description: "A serene, dangerous lake.", backgroundImage: "https://placehold.co/800x200/4169E1/FFFFFF?text=Crystal+Lake&font=pressstart2p", shops: [], monsters: ["Puddle Sprite", "Deep One"], isSafe: false, recommendedLevel: 2, dominantElement: "Water" }
        };
        console.log("Early Init Fix: Created missing GAME_AREAS");
      }
      
      // 6. Define monsterTemplates if missing
      if (!window.monsterTemplates || window.monsterTemplates.length === 0) {
        window.monsterTemplates = [
          { name: "Tiny Flame Imp", type: "Fire", baseMaxHp: 35, baseAttack: 7, baseDefense: 1, expReward: 12, goldReward: 7, spriteKey: "TinyFlameImp", skills: [{ name: "Scratch", damageMultiplier: 1.0, type: "Normal", chance: 0.7 }, { name: "Small Ember", damageMultiplier: 1.1, type: "Fire", chance: 0.3 }] },
          { name: "Puddle Sprite", type: "Water", baseMaxHp: 45, baseAttack: 6, baseDefense: 2, expReward: 14, goldReward: 8, spriteKey: "PuddleSprite", skills: [{ name: "Splash", damageMultiplier: 1.0, type: "Normal", chance: 0.6 }, { name: "Weak Bubble", damageMultiplier: 1.0, type: "Water", chance: 0.4 }] },
          { name: "Forest Wisp", type: "Nature", baseMaxHp: 50, baseAttack: 9, baseDefense: 2, expReward: 18, goldReward: 9, spriteKey: "ForestWisp", skills: [{ name: "Tackle", damageMultiplier: 1.0, type: "Normal", chance: 0.5 }, { name: "Leaf Cutter", damageMultiplier: 1.2, type: "Nature", chance: 0.5 }] }
        ];
        console.log("Early Init Fix: Created missing monsterTemplates");
      }
      
      // 7. Define bossMonsterTemplates if missing
      if (!window.bossMonsterTemplates || window.bossMonsterTemplates.length === 0) {
        window.bossMonsterTemplates = [
          { name: "GRONK, Earth Titan", type: "Earth", baseMaxHp: 220, baseAttack: 15, baseDefense: 8, expReward: 120, goldReward: 80, spriteKey: "GronkBoss", skills: [ { name: "Titan Slam", damageMultiplier: 1.5, type: "Earth", chance: 0.6, description: "A devastating slam." }, { name: "Earthquake", damageMultiplier: 1.2, type: "Earth", chance: 0.3, aoe: true, description: "Shakes the ground." }, { name: "Stone Skin", damageMultiplier: 0, type: "Buff", effect: "defense_up", chance: 0.2, description: "Boosts Defense." } ], isBoss: true },
          { name: "VOIDMAW, Hungering Dark", type: "Dark", baseMaxHp: 180, baseAttack: 20, baseDefense: 6, expReward: 150, goldReward: 100, spriteKey: "VoidmawBoss", skills: [ { name: "Shadow Claw", damageMultiplier: 1.4, type: "Dark", chance: 0.5, description: "Dark claws." }, { name: "Devouring Void", damageMultiplier: 1.0, type: "Dark", chance: 0.3, effect: "hp_drain", description: "Drains life." }, { name: "Nightmare Veil", damageMultiplier: 0, type: "Debuff", effect: "accuracy_down", chance: 0.2, description: "Lowers accuracy." } ], isBoss: true }
        ];
        console.log("Early Init Fix: Created missing bossMonsterTemplates");
      }
      
      // 8. Define monsterSprites if missing
      if (!window.monsterSprites) {
        window.monsterSprites = {
          TinyFlameImp: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'%3E%3Crect width='240' height='240' fill='%23FF7F50'/%3E%3Ctext x='120' y='100' font-family='Arial' font-size='60' fill='black' text-anchor='middle' dominant-baseline='middle'%3E🔥%3C/text%3E%3Ctext x='120' y='160' font-family='Arial' font-size='40' fill='black' text-anchor='middle'%3EIMP%3C/text%3E%3C/svg%3E",
          PuddleSprite: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'%3E%3Crect width='240' height='240' fill='%23ADD8E6'/%3E%3Ctext x='120' y='100' font-family='Arial' font-size='60' fill='black' text-anchor='middle' dominant-baseline='middle'%3E💧%3C/text%3E%3Ctext x='120' y='160' font-family='Arial' font-size='40' fill='black' text-anchor='middle'%3EPUDDLE%3C/text%3E%3C/svg%3E",
          ForestWisp: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'%3E%3Crect width='240' height='240' fill='%2390EE90'/%3E%3Ctext x='120' y='100' font-family='Arial' font-size='60' fill='black' text-anchor='middle' dominant-baseline='middle'%3E🌿%3C/text%3E%3Ctext x='120' y='160' font-family='Arial' font-size='40' fill='black' text-anchor='middle'%3EWISP%3C/text%3E%3C/svg%3E",
          DefaultMonster: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'%3E%3Crect width='240' height='240' fill='%23708090'/%3E%3Ctext x='120' y='120' font-family='Arial' font-size='80' fill='white' text-anchor='middle' dominant-baseline='middle'%3E😈%3C/text%3E%3C/svg%3E",
          Victory: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'%3E%3Crect width='240' height='240' fill='%2377DD77'/%3E%3Ctext x='120' y='100' font-family='Arial' font-size='80' fill='black' text-anchor='middle' dominant-baseline='middle'%3E😎%3C/text%3E%3Ctext x='120' y='160' font-family='Arial' font-size='40' fill='black' text-anchor='middle'%3EWIN!%3C/text%3E%3C/svg%3E",
          GameOver: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'%3E%3Crect width='240' height='240' fill='%23808080'/%3E%3Ctext x='120' y='100' font-family='Arial' font-size='80' fill='white' text-anchor='middle' dominant-baseline='middle'%3E😵%3C/text%3E%3Ctext x='120' y='160' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3EGAME OVER%3C/text%3E%3C/svg%3E"
        };
        console.log("Early Init Fix: Created missing monsterSprites");
      }
      
      // 9. Define runeIcons if missing
      if (!window.runeIcons) {
        window.runeIcons = { 
          Fire: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23FF6347'/%3E%3Ctext x='40' y='50' font-family='Arial' font-size='40' fill='black' text-anchor='middle' dominant-baseline='middle'%3E🔥%3C/text%3E%3C/svg%3E",
          Water: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%234682B4'/%3E%3Ctext x='40' y='50' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E💧%3C/text%3E%3C/svg%3E",
          Nature: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%233CB371'/%3E%3Ctext x='40' y='50' font-family='Arial' font-size='40' fill='black' text-anchor='middle' dominant-baseline='middle'%3E🌿%3C/text%3E%3C/svg%3E",
          Light: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23FFFACD'/%3E%3Ctext x='40' y='50' font-family='Arial' font-size='40' fill='black' text-anchor='middle' dominant-baseline='middle'%3E✨%3C/text%3E%3C/svg%3E",
          Dark: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%234B0082'/%3E%3Ctext x='40' y='50' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E🌑%3C/text%3E%3C/svg%3E"
        };
        console.log("Early Init Fix: Created missing runeIcons");
      }
      
      // 10. Define game constants if they're missing
      if (!window.PLAYER_BASE_HP) {
        window.PLAYER_BASE_HP = 100;
        window.PLAYER_HP_PER_LEVEL = 34;
        window.PLAYER_BASE_MANA = 55;
        window.PLAYER_MANA_PER_LEVEL = 15;
        window.PLAYER_BASE_ATTACK_POWER = 7;
        window.PLAYER_ATTACK_POWER_PER_LEVEL = 4;
        window.PLAYER_BASE_DEFENSE = 3;
        window.PLAYER_DEFENSE_PER_LEVEL = 2;
        window.PLAYER_SKILL_DAMAGE_SCALING_FACTOR = 3.5;
        window.PLAYER_HEAL_SCALING_FACTOR = 3.0;
        
        window.MONSTER_ATTACK_SCALING_PER_PLAYER_LEVEL = 1.4;
        window.MONSTER_DEFENSE_SCALING_PER_PLAYER_LEVEL = 0.8;
        window.MONSTER_HP_SCALING_PER_PLAYER_LEVEL = 8;
        
        window.BOSS_MONSTER_INTERVAL = 10;
        
        window.MELEE_ATTACK_ID = "melee_attack";
        window.MELEE_MANA_REGEN = 9;
        window.MELEE_DAMAGE_BASE_PERCENT_OF_ATTACK = 1.0;
        
        window.HEAL_ON_DEFEAT_PERCENT_HP = 0.35;
        window.REGEN_ON_DEFEAT_PERCENT_MANA = 0.40;
        
        window.INITIAL_EXP_TO_LEVEL = 50;
        window.EXP_CURVE_FACTOR = 1.23;
        window.EXP_CURVE_FLAT_ADDITION = 20;
        
        console.log("Early Init Fix: Created missing game constants");
      }
      
      // 11. Fix player data initialization with constants
      if (window.playerData && window.PLAYER_BASE_HP) {
        window.playerData.hp = window.PLAYER_BASE_HP;
        window.playerData.maxHp = window.PLAYER_BASE_HP;
        window.playerData.mana = window.PLAYER_BASE_MANA;
        window.playerData.maxMana = window.PLAYER_BASE_MANA;
        window.playerData.attackPower = window.PLAYER_BASE_ATTACK_POWER;
        window.playerData.defense = window.PLAYER_BASE_DEFENSE;
        window.playerData.nextLevelExp = window.INITIAL_EXP_TO_LEVEL;
        console.log("Early Init Fix: Updated playerData with constant values");
      }
      
      // 12. Set player avatar to default if not set
      if (window.playerData && window.heroAvatars && window.heroAvatars.Default) {
        window.playerData.avatar = window.heroAvatars.Default;
        console.log("Early Init Fix: Set default avatar for player");
      }
      
      console.log("Early Init Fix: Pre-initialization complete");
    })();
    </script>
    
    <!-- Original Game Script -->
    <script src="script.js"></script>
    
    <!-- Fix Scripts -->
    <script src="game-fix-script.js"></script>
    <script src="combat-fix-script.js"></script>
    <script src="ui-optimization-script.js"></script>
</body>
</html>